# Import the Active Directory module
Import-Module ActiveDirectory

# Get all domain-joined servers
$servers = Get-ADComputer -Filter {OperatingSystem -like "*Server*"} -Property Name | Select-Object -ExpandProperty Name

# Create a list to store results
$results = @()

# Loop through each server to check if IPv6 is enabled
foreach ($server in $servers) {
    try {
        $networkAdapters = Invoke-Command -ComputerName $server -ScriptBlock {
            Get-NetAdapterBinding -ComponentID ms_tcpip6 | Select-Object Name, Enabled
        }

        foreach ($adapter in $networkAdapters) {
            $beforeStatus = $adapter.Enabled
            $afterStatus = $beforeStatus

            # If IPv6 is enabled, disable it
            if ($beforeStatus) {
                Invoke-Command -ComputerName $server -ScriptBlock {
                    Get-NetAdapterBinding -ComponentID ms_tcpip6 | Where-Object {$_.Enabled} | Disable-NetAdapterBinding -ComponentID ms_tcpip6 -Confirm:$false
                }
                $afterStatus = $false
            }

            # Record the before and after status
            $results += [PSCustomObject]@{
                Server = $server
                Adapter = $adapter.Name
                IPv6EnabledBefore = $beforeStatus
                IPv6EnabledAfter = $afterStatus
            }
        }
    } catch {
        #Write-Warning "Failed to query $server: $($_)"
        $results += [PSCustomObject]@{
            Server = $server
            Adapter = "N/A"
            IPv6EnabledBefore = "Failed to connect"
            IPv6EnabledAfter = "Failed to connect"
        }
    }
}

# Output the results
$results | Format-Table -AutoSize

# Export the results to a CSV file
$results | Export-Csv -Path "c:\Path\IPv6StatusBeforeAndAfter.csv" -NoTypeInformation
